<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคำนวณเกรด</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for bar chart and other elements */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for striped rows in the table */
        #resultsTableBody tr:nth-child(odd) {
            background-color: white;
        }
        #resultsTableBody tr:nth-child(even) {
            background-color: #f9fafb; /* Lighter shade of gray for stripes */
        }
        /* Custom styles for the bar chart */
        .bar-container {
            position: relative;
            height: 150px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
            transition: all 0.5s ease-in-out;
        }
        .bar {
            width: 100%;
            background-color: #3b82f6; /* Default bar color (blue-500) */
            border-radius: 4px;
            transition: height 0.5s ease-in-out;
        }
        .bar-label {
            margin-top: 5px;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .bar-value {
            font-size: 0.75rem;
            margin-bottom: 5px;
            font-weight: bold;
        }
        /* Style for the custom modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <!-- Main Container (Card) -->
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-10 border-t-8 border-blue-500">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-blue-800">
            ระบบตัดเกรด
        </h1>

        <!-- Dashboard and Chart Section (New) -->
        <div class="mb-8 p-6 bg-blue-50 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-blue-700">ภาพรวมผลการเรียน</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Total Students Card -->
                <div class="bg-white rounded-lg p-5 shadow-md text-center">
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">จำนวนนักเรียนทั้งหมด</h3>
                    <p id="totalStudents" class="mt-1 text-4xl font-bold text-blue-600">0</p>
                </div>
                <!-- Average Score Card -->
                <div class="bg-white rounded-lg p-5 shadow-md text-center">
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">คะแนนเฉลี่ยรวม</h3>
                    <p id="averageScore" class="mt-1 text-4xl font-bold text-pink-600">0.00</p>
                </div>
                <!-- Average Grade Card -->
                <div class="bg-white rounded-lg p-5 shadow-md text-center">
                    <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider">เกรดเฉลี่ย</h3>
                    <p id="averageGrade" class="mt-1 text-4xl font-bold text-teal-600">
                        <span id="averageGradeLabel">-</span>
                    </p>
                </div>
            </div>

            <!-- Grade Count Bar Chart -->
            <div class="bg-white rounded-lg p-5 shadow-md">
                <h3 class="text-gray-700 text-lg font-medium mb-4">จำนวนนักเรียนในแต่ละเกรด</h3>
                <div id="gradeCountChart" class="bar-container">
                    <!-- Bars will be generated by JS -->
                </div>
                <!-- Grade average scores will be displayed here -->
                <div id="gradeAverageScores" class="mt-6">
                    <h3 class="text-gray-700 text-lg font-medium mb-2">คะแนนเฉลี่ยในแต่ละเกรด</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600" id="averageScoreList">
                        <!-- List items will be generated by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Weight Settings Section (Card) -->
        <div class="mb-8 p-6 bg-blue-50 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold mb-3 text-blue-700">ตั้งค่าน้ำหนักคะแนน</h2>
            <div class="md:flex md:space-x-4 space-y-4 md:space-y-0 items-end">
                <div class="flex-1">
                    <label for="workWeight" class="block text-gray-700 font-medium">น้ำหนักคะแนนเก็บ (0-1):</label>
                    <input type="number" id="workWeight" value="0.6" step="0.01" min="0" max="1"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2.5">
                </div>
                <div class="flex-1">
                    <label for="examWeight" class="block text-gray-700 font-medium">น้ำหนักคะแนนสอบ (0-1):</label>
                    <input type="number" id="examWeight" value="0.4" step="0.01" min="0" max="1"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition duration-150 ease-in-out p-2.5">
                </div>
                <button id="updateWeights" class="bg-blue-600 text-white font-bold py-2.5 px-6 rounded-full shadow-md hover:bg-blue-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out w-full md:w-auto">
                    อัปเดตน้ำหนัก
                </button>
            </div>
        </div>

        <!-- Add Student Form Section (Card) -->
        <div class="mb-8 p-6 bg-white border border-gray-200 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">เพิ่มรายชื่อนักเรียน</h2>
            <form id="studentForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-1 md:col-span-1">
                    <label for="studentName" class="block text-gray-700 font-medium">ชื่อ-นามสกุล:</label>
                    <input type="text" id="studentName" required placeholder="ชื่อนักเรียน"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition duration-150 ease-in-out p-2.5">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label for="workScore" class="block text-gray-700 font-medium">คะแนนเก็บ (เต็ม 100):</label>
                    <input type="number" id="workScore" required min="0" max="100" placeholder="คะแนนเก็บ"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition duration-150 ease-in-out p-2.5">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label for="examScore" class="block text-gray-700 font-medium">คะแนนสอบ (เต็ม 100):</label>
                    <input type="number" id="examScore" required min="0" max="100" placeholder="คะแนนสอบ"
                        class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition duration-150 ease-in-out p-2.5">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <button type="submit" class="bg-pink-600 text-white font-bold py-2.5 px-6 rounded-full shadow-md hover:bg-pink-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 transition duration-300 ease-in-out w-full">
                        เพิ่มนักเรียน
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Table Section -->
        <div>
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-2 md:mb-0">ผลการคำนวณเกรด</h2>
                <div class="flex space-x-2">
                    <button id="calculateAll" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-blue-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                        คำนวณเกรดทั้งหมด
                    </button>
                    <button id="clearAll" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-red-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                        ล้างข้อมูลทั้งหมด
                    </button>
                    <button id="exportCsvBtn" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-pink-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                        EXPORT CSV
                    </button>
                    <!-- New Import CSV button -->
                    <button id="importCsvBtn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-teal-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                        IMPORT CSV
                    </button>
                    <!-- Hidden file input element -->
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ชื่อ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">คะแนนเก็บ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">คะแนนสอบ</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">คะแนนรวม</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">เกรด</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"></th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody" class="divide-y divide-gray-200">
                        <!-- Student data will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <div id="modalMessage" class="text-gray-700 font-medium mb-4"></div>
            <div class="modal-buttons">
                <button id="modalOkBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300 ease-in-out">ตกลง</button>
                <button id="modalCancelBtn" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-500 transition duration-300 ease-in-out hidden">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script>
        // Wait for the entire page to load before running the script
        window.onload = function() {
            // --- Global variables and DOM element references ---
            const studentForm = document.getElementById('studentForm');
            const studentNameInput = document.getElementById('studentName');
            const workScoreInput = document.getElementById('workScore');
            const examScoreInput = document.getElementById('examScore');
            const resultsTableBody = document.getElementById('resultsTableBody');
            const calculateAllBtn = document.getElementById('calculateAll');
            const clearAllBtn = document.getElementById('clearAll');
            const updateWeightsBtn = document.getElementById('updateWeights');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const importCsvBtn = document.getElementById('importCsvBtn'); // New import button
            const csvFileInput = document.getElementById('csvFileInput'); // New hidden file input
            const workWeightInput = document.getElementById('workWeight');
            const examWeightInput = document.getElementById('examWeight');
            
            // Dashboard DOM elements
            const totalStudentsElem = document.getElementById('totalStudents');
            const averageScoreElem = document.getElementById('averageScore');
            const gradeCountChartElem = document.getElementById('gradeCountChart');
            const averageGradeLabelElem = document.getElementById('averageGradeLabel');
            const averageScoreListElem = document.getElementById('averageScoreList');
            
            // Custom Modal DOM elements
            const customModal = document.getElementById('customModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalOkBtn = document.getElementById('modalOkBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            // Array to store all student data
            let students = [];

            // Default grade criteria
            const gradeCriteria = {
                'A': 80,
                'B': 70,
                'C': 60,
                'D': 50,
                'F': 0
            };
            const gradeColors = {
                'A': '#22c55e', // green-500
                'B': '#3b82f6', // blue-500
                'C': '#f59e0b', // amber-500
                'D': '#f97316', // orange-500
                'F': '#ef4444' // red-500
            };
            const gradesOrder = ['A', 'B', 'C', 'D', 'F'];

            // --- Custom Modal Functions ---
            let modalResolve;

            function showCustomModal(message, isConfirm = false) {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    modalCancelBtn.classList.toggle('hidden', !isConfirm);
                    customModal.style.display = 'flex';
                    modalResolve = resolve;
                });
            }

            modalOkBtn.addEventListener('click', () => {
                customModal.style.display = 'none';
                modalResolve(true);
            });

            modalCancelBtn.addEventListener('click', () => {
                customModal.style.display = 'none';
                modalResolve(false);
            });


            // --- Local Storage Functions ---

            // Function to save student data to localStorage
            const saveToLocalStorage = () => {
                try {
                    localStorage.setItem('students', JSON.stringify(students));
                } catch (e) {
                    console.error('Error saving to localStorage', e);
                }
            };

            // Function to load student data from localStorage
            const loadFromLocalStorage = () => {
                try {
                    const savedStudents = localStorage.getItem('students');
                    if (savedStudents) {
                        students = JSON.parse(savedStudents);
                    }
                } catch (e) {
                    console.error('Error loading from localStorage', e);
                }
            };

            // --- Core Calculation Functions ---

            // Function to calculate the weighted total score
            const calculateTotalScore = (work, exam) => {
                const workWeight = parseFloat(workWeightInput.value);
                const examWeight = parseFloat(examWeightInput.value);
                return (work * workWeight) + (exam * examWeight);
            };

            // Function to determine the letter grade
            const calculateGrade = (totalScore) => {
                if (totalScore >= gradeCriteria['A']) return 'A';
                if (totalScore >= gradeCriteria['B']) return 'B';
                if (totalScore >= gradeCriteria['C']) return 'C';
                if (totalScore >= gradeCriteria['D']) return 'D';
                return 'F';
            };

            // --- Rendering Functions ---

            // Function to update the dashboard stats and charts
            const updateDashboard = () => {
                if (students.length === 0) {
                    totalStudentsElem.textContent = 0;
                    averageScoreElem.textContent = '0.00';
                    averageGradeLabelElem.textContent = '-';
                    gradeCountChartElem.innerHTML = '';
                    averageScoreListElem.innerHTML = '';
                    return;
                }

                // Calculate overall stats
                const totalStudents = students.length;
                const totalScoreSum = students.reduce((sum, student) => sum + (student.totalScore || 0), 0);
                const averageOverallScore = totalScoreSum / totalStudents;
                
                // Update the stat cards
                totalStudentsElem.textContent = totalStudents;
                averageScoreElem.textContent = averageOverallScore.toFixed(2);
                
                // Group students by grade and calculate counts and average scores
                const gradeData = students.reduce((acc, student) => {
                    if (student.grade) {
                        if (!acc[student.grade]) {
                            acc[student.grade] = { count: 0, totalScore: 0 };
                        }
                        acc[student.grade].count += 1;
                        acc[student.grade].totalScore += student.totalScore;
                    }
                    return acc;
                }, {});

                // Determine the most common grade for the average grade card
                let mostCommonGrade = '-';
                let maxCount = 0;
                for (const grade in gradeData) {
                    if (gradeData[grade].count > maxCount) {
                        maxCount = gradeData[grade].count;
                        mostCommonGrade = grade;
                    }
                }
                averageGradeLabelElem.textContent = mostCommonGrade;

                // Create and render the bar chart for counts
                gradeCountChartElem.innerHTML = '';
                const maxCountValue = Math.max(...Object.values(gradeData).map(g => g.count), 1); // Avoid division by zero
                
                gradesOrder.forEach(grade => {
                    const count = gradeData[grade]?.count || 0;
                    const heightPercentage = (count / maxCountValue) * 100;

                    const barItem = document.createElement('div');
                    barItem.classList.add('bar-item');

                    const barValue = document.createElement('div');
                    barValue.classList.add('bar-value');
                    barValue.textContent = count;

                    const bar = document.createElement('div');
                    bar.classList.add('bar');
                    bar.style.height = `${heightPercentage}%`;
                    bar.style.backgroundColor = gradeColors[grade];
                    
                    const barLabel = document.createElement('div');
                    barLabel.classList.add('bar-label');
                    barLabel.textContent = grade;

                    barItem.appendChild(barValue);
                    barItem.appendChild(bar);
                    barItem.appendChild(barLabel);

                    gradeCountChartElem.appendChild(barItem);
                });

                // Render the list of average scores by grade
                averageScoreListElem.innerHTML = '';
                gradesOrder.forEach(grade => {
                    const data = gradeData[grade];
                    const avgScore = data ? (data.totalScore / data.count).toFixed(2) : 'N/A';
                    const listItem = document.createElement('li');
                    listItem.textContent = `เกรด ${grade}: ${avgScore} คะแนน`;
                    averageScoreListElem.appendChild(listItem);
                });
            };

            // Function to render the student data table
            const renderTable = () => {
                resultsTableBody.innerHTML = ''; // Clear the table first
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-200'); // Add hover effect to rows

                    // Set grade color for visual distinction
                    let gradeColor = 'text-gray-900';
                    if (student.grade === 'A') gradeColor = 'text-green-600 font-bold';
                    else if (student.grade === 'B') gradeColor = 'text-blue-600';
                    else if (student.grade === 'C') gradeColor = 'text-yellow-600';
                    else if (student.grade === 'D') gradeColor = 'text-orange-600';
                    else if (student.grade === 'F') gradeColor = 'text-red-600 font-bold';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <input type="number" value="${student.workScore}" min="0" max="100" data-index="${index}" data-score-type="workScore" class="w-20 px-2 py-1 border rounded-md text-sm text-center focus:outline-none focus:ring focus:ring-pink-300">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <input type="number" value="${student.examScore}" min="0" max="100" data-index="${index}" data-score-type="examScore" class="w-20 px-2 py-1 border rounded-md text-sm text-center focus:outline-none focus:ring focus:ring-pink-300">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${student.totalScore !== null ? student.totalScore.toFixed(2) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${gradeColor}">${student.grade !== null ? student.grade : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="delete-btn text-red-600 hover:text-red-900" data-index="${index}">ลบ</button>
                        </td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                updateDashboard(); // Update dashboard after rendering the table
            };

            // --- Event Handlers ---

            // Handle score input change
            resultsTableBody.addEventListener('change', (e) => {
                const target = e.target;
                if (target.matches('input[type="number"]')) {
                    const index = parseInt(target.dataset.index, 10);
                    const scoreType = target.dataset.scoreType;
                    const newValue = parseFloat(target.value);

                    if (!isNaN(newValue) && newValue >= 0 && newValue <= 100) {
                        students[index][scoreType] = newValue;
                        students[index].totalScore = calculateTotalScore(students[index].workScore, students[index].examScore);
                        students[index].grade = calculateGrade(students[index].totalScore);
                        renderTable();
                        saveToLocalStorage();
                    } else {
                        // Reset to previous valid value if input is invalid
                        target.value = students[index][scoreType];
                        showCustomModal('กรุณากรอกคะแนนระหว่าง 0 ถึง 100');
                    }
                }
            });

            // Handle form submission to add a new student
            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = studentNameInput.value.trim();
                const workScore = parseFloat(workScoreInput.value);
                const examScore = parseFloat(examScoreInput.value);

                if (name && !isNaN(workScore) && !isNaN(examScore)) {
                    // Create a new student object
                    const newStudent = {
                        name,
                        workScore,
                        examScore,
                        totalScore: null,
                        grade: null
                    };
                    students.push(newStudent);
                    renderTable();
                    saveToLocalStorage();
                    studentForm.reset(); // Clear the form inputs
                }
            });

            // Handle the "Calculate All" button click
            calculateAllBtn.addEventListener('click', () => {
                if (students.length === 0) {
                    showCustomModal('กรุณาเพิ่มนักเรียนก่อน');
                    return;
                }
                students.forEach(student => {
                    student.totalScore = calculateTotalScore(student.workScore, student.examScore);
                    student.grade = calculateGrade(student.totalScore);
                });
                renderTable();
                saveToLocalStorage();
            });

            // Handle "Clear All" button click
            clearAllBtn.addEventListener('click', async () => {
                const confirmed = await showCustomModal('คุณแน่ใจหรือไม่ที่จะล้างข้อมูลนักเรียนทั้งหมด?', true);
                if (confirmed) {
                    students = [];
                    renderTable();
                    saveToLocalStorage();
                }
            });

            // Handle "Update Weights" button click
            updateWeightsBtn.addEventListener('click', () => {
                const workWeight = parseFloat(workWeightInput.value);
                const examWeight = parseFloat(examWeightInput.value);
                
                if (Math.abs(workWeight + examWeight - 1.0) > 0.001) { // Using a tolerance for floating point comparison
                    showCustomModal('ผลรวมของน้ำหนักคะแนนต้องเท่ากับ 1.0');
                    return;
                }
                showCustomModal('อัปเดตน้ำหนักคะแนนเรียบร้อยแล้ว');
                calculateAllBtn.click(); // Re-calculate grades with new weights
            });

            // Handle "Export CSV" button click
            exportCsvBtn.addEventListener('click', () => {
                if (students.length === 0) {
                    showCustomModal('ไม่มีข้อมูลนักเรียนให้ส่งออก');
                    return;
                }
                
                // Headers for the CSV file
                const headers = ['ลำดับ', 'ชื่อ', 'คะแนนเก็บ', 'คะแนนสอบ', 'คะแนนรวม', 'เกรด'];
                
                // Create the data rows
                const rows = students.map((student, index) => {
                    return [
                        index + 1,
                        `"${student.name}"`, // Enclose name in quotes to handle commas
                        student.workScore,
                        student.examScore,
                        student.totalScore !== null ? student.totalScore.toFixed(2) : '',
                        student.grade || ''
                    ].join(',');
                });
                
                // Combine headers and rows
                const csvContent = [headers.join(','), ...rows].join('\n');
                
                // Create a Blob from the CSV content
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                if (link.download !== undefined) { // Check if the download attribute is supported
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'grades.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // --- New functionality for importing CSV data ---
            importCsvBtn.addEventListener('click', () => {
                // Trigger the hidden file input click
                csvFileInput.click();
            });

            csvFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').slice(1); // Skip header row
                        const importedStudents = [];

                        lines.forEach(line => {
                            const data = line.trim().split(',');
                            if (data.length >= 4) { // Ensure data has at least name, work score, and exam score
                                const name = data[1].replace(/"/g, '').trim(); // Clean up name from quotes
                                const workScore = parseFloat(data[2]);
                                const examScore = parseFloat(data[3]);

                                if (name && !isNaN(workScore) && !isNaN(examScore)) {
                                    importedStudents.push({
                                        name,
                                        workScore,
                                        examScore,
                                        totalScore: null,
                                        grade: null
                                    });
                                }
                            }
                        });

                        if (importedStudents.length > 0) {
                            students = students.concat(importedStudents);
                            renderTable();
                            saveToLocalStorage();
                            showCustomModal(`นำเข้าข้อมูลนักเรียน ${importedStudents.length} คนเรียบร้อยแล้ว`);
                        } else {
                            showCustomModal('ไม่พบข้อมูลนักเรียนที่ถูกต้องในไฟล์');
                        }
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        showCustomModal('เกิดข้อผิดพลาดในการนำเข้าไฟล์ กรุณาลองใหม่อีกครั้ง');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            });
            
            // --- End of new import functionality ---

            // Use event delegation for the "Delete" buttons
            resultsTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (!isNaN(index)) {
                        students.splice(index, 1);
                        renderTable();
                        saveToLocalStorage();
                    }
                }
            });

            // --- Initial Data Loading and Setup ---

            // Function to add sample students if localStorage is empty
            const addInitialStudents = () => {
                if (students.length === 0) {
                    const sampleStudents = [
                        { name: 'สมชาย รักเรียน', workScore: 85, examScore: 92, totalScore: null, grade: null },
                        { name: 'สมศรี ขยันดี', workScore: 65, examScore: 78, totalScore: null, grade: null },
                        { name: 'มานะ พากเพียร', workScore: 95, examScore: 50, totalScore: null, grade: null },
                        { name: 'มานี เก่งกาจ', workScore: 70, examScore: 68, totalScore: null, grade: null },
                        { name: 'วิชัย พัฒนา', workScore: 45, examScore: 30, totalScore: null, grade: null }
                    ];
                    students = sampleStudents;
                }
            };

            // Initial setup: Load data and render the table
            loadFromLocalStorage();
            addInitialStudents(); // Add sample data if none is loaded
            renderTable();

            // Automatically calculate grades on initial load if data exists
            if (students.length > 0) {
                 calculateAllBtn.click();
            }
        };
    </script>

</body>
</html>
